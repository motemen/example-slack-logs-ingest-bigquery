in:
  # type: file
  # path_prefix: {{ env.PREPROCESSED_JSON_DIR }}/
  type: command
  command: |
    set -e
    for zip in /data/*.zip; do
      echo "# Unzipping $zip ..." >&2
      json_dir="/tmp/$(basename "$zip")"
      unzip -o -q "$zip" -d "$json_dir"
      for file in "$json_dir"/*/*.json; do
        ch=$(basename "$(dirname "$file")")
        cat "$file" | jq -c --arg ch "$ch" 'map(. + {channel: $ch}) | .[]'
      done
    done
  parser:
    type: json
    columns:
      - { name: ts, type: string }
      - { name: timestamp, type: double, element_at: /ts }
      - { name: subtype, type: string }
      - { name: channel, type: string }
      - { name: user_name, type: string, element_at: /user_profile/name }
      - { name: text, type: string }
      - { name: reactions, type: json }
  # parser:
  #   type: json
  #   flatten_json_array: true
  #   root: /messages
  #   columns:
  #     - { name: user_real_name, type: string, path: "user_profile.real_name" }
  #     - { name: ts, type: string }
  #     - { name: timestamp, type: double, path: ts }
  #     - { name: text, type: string }
  #     - { name: reactions, type: json }
filters:
  - type: timestamp_format
    columns:
      - { name: timestamp, type: timestamp }
  - type: null_string
    columns:
      - { name: subtype, null_string: "" }
      - { name: user_name, null_string: "" }
      - { name: reactions, null_string: "" }
{% include "out" %}
